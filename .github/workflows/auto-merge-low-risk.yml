name: auto-merge-low-risk

on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-automerge:
    if: >-
      github.event.pull_request.draft == false &&
      contains(github.event.pull_request.labels.*.name, 'low-risk') &&
      contains(github.event.pull_request.labels.*.name, 'automerge')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.AUTO_FIX_PAT || secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

      - name: Notify webhook
        if: always()
        env:
          NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
          NOTIFY_PROVIDER: ${{ vars.NOTIFY_PROVIDER || 'feishu' }}
          NOTIFY_STATUS: ${{ job.status }}
          NOTIFY_TITLE: auto-merge-low-risk
          NOTIFY_MESSAGE: >-
            repository=${{ github.repository }}
            pr=${{ github.event.pull_request.number }}
            run=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          bash ./scripts/notify_webhook.sh
