name: daily-rank-sync

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-ios-rank:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Run daily rank sync
        env:
          APPSTORE_COUNTRIES: ${{ vars.APPSTORE_COUNTRIES || 'cn,us,jp' }}
          APPSTORE_MEDIA_TYPES: ${{ vars.APPSTORE_MEDIA_TYPES || 'apps,games' }}
          APPSTORE_FEEDS: ${{ vars.APPSTORE_FEEDS || vars.APPSTORE_FEED || 'top-free,top-paid' }}
          APPSTORE_FEED: ${{ vars.APPSTORE_FEED || 'top-free,top-paid' }}
          APPSTORE_LIMIT: ${{ vars.APPSTORE_LIMIT || '100' }}
          APPSTORE_GENRE_APPS: ${{ vars.APPSTORE_GENRE_APPS || '6000' }}
          APPSTORE_GENRE_GAMES: ${{ vars.APPSTORE_GENRE_GAMES || '6014' }}
          FETCH_CONCURRENCY: ${{ vars.FETCH_CONCURRENCY || '2' }}
          FETCH_RETRIES: ${{ vars.FETCH_RETRIES || '3' }}
          FETCH_RETRY_DELAY_MS: ${{ vars.FETCH_RETRY_DELAY_MS || '1500' }}
        run: |
          npm run sync:ios-rank --if-present
          npm run rank:daily --if-present

      - name: Validate data coverage
        env:
          EXPECTED_COUNTRIES: ${{ vars.APPSTORE_COUNTRIES || 'cn,us,jp' }}
          EXPECTED_MEDIA_TYPES: ${{ vars.APPSTORE_MEDIA_TYPES || 'apps,games' }}
          EXPECTED_FEEDS: ${{ vars.APPSTORE_FEEDS || vars.APPSTORE_FEED || 'top-free,top-paid' }}
          MIN_COVERAGE_RATIO: ${{ vars.MIN_COVERAGE_RATIO || '1.0' }}
        run: |
          bash scripts/validate_data.sh

      - name: Prune old snapshots
        id: prune
        env:
          DATA_RETENTION_DAYS: ${{ vars.DATA_RETENTION_DAYS || '14' }}
          PRUNE_ARCHIVE_DIR: /tmp/prune-archive
        run: |
          bash scripts/prune_data.sh

      - name: Upload prune archive
        if: steps.prune.outputs.archive_file != ''
        uses: actions/upload-artifact@v6
        with:
          name: pruned-snapshots-${{ github.run_id }}
          path: ${{ steps.prune.outputs.archive_file }}

      - name: Create pull request for rank data update
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.AUTO_FIX_PAT || secrets.GITHUB_TOKEN }}
          branch: chore/daily-rank-${{ github.run_id }}
          commit-message: 'chore: update ios daily rank data'
          title: 'chore: iOS daily rank update'
          body: |
            Automated daily iOS ranking data update.
            - Workflow: daily-rank-sync
            - Run ID: ${{ github.run_id }}
          labels: |
            enhancement

      - name: Notify webhook
        if: always()
        env:
          NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
          NOTIFY_PROVIDER: ${{ vars.NOTIFY_PROVIDER || 'feishu' }}
          NOTIFY_STATUS: ${{ job.status }}
          NOTIFY_TITLE: daily-rank-sync
          NOTIFY_MESSAGE: >-
            repository=${{ github.repository }}
            run=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            pr=${{ steps.cpr.outputs.pull-request-number || 'none' }}
        run: |
          bash scripts/notify_webhook.sh
